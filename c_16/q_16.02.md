# 「世界で闘うプログラミング力を鍛える150問」の問題16.2の回答

## 問題

コンテキストスイッチにかかる時間測定をどのように行いますか?

## 回答

コンテキストスイッチとは
(通常は1つのCPUにおける) 2つのプロセスの切り替え処理であり、
マルチタスクのシステムで起こる。
OSは、実行中プロセスの状態の情報を保存し、待機プロセスの状態を復元する。

* [Wikipedia / コンテキストスイッチ](https://ja.wikipedia.org/wiki/%E3%82%B3%E3%83%B3%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%82%B9%E3%82%A4%E3%83%83%E3%83%81)

実際に測定する方法として、
プロセス間通信する機能を持つ以下のプログラムXを用意する。

* 同じプログラムの指定したプロセスにトークンを送信する。
* 同じプログラムの指定したプロセスからトークンを受信する。
* 「送信→待機→受信」もしくは「待機→受信→送信」のいずれかの処理を行う。
* トークンの送信前の時刻を記憶し、上記のいずれかの処理が完了したタイミングでそれを書き出す。
* トークンの受信後の時刻を記憶し、上記のいずれかの処理が完了したタイミングでそれを書き出す。

まず最初に、プログラムXからプロセスP1, P2を生成して通信させる。

1. XからP1, P2を生成する。
1. P1からP2にトークンを送信する。送信開始時P2が実行可能になる。
1. P2はトークンを受信する。送信完了後P1は待機する。
1. P2からP1にトークンを送信する。送信開始時P1が実行可能になる。
1. P1はトークンを受信する。
1. P1, P2はそれぞれ送受信時刻を書き出す。

この時、プロセスP1の送信前〜送信後の時間Aは以下の通りになる。

    送信前〜送信後 = (トークン送信にかかる時間 + トークン受信にかかる時間) * 2 + プロセス待機にかかる時間 + プロセス復帰にかかる時間

さらにP1単独で通信させる。

1. XからP1を生成する。
1. P1からP1にトークンを送信する。
1. P1はトークンを受信する。
1. P1からP1にトークンを送信する。
1. P1はトークンを受信する。
1. P1は送受信時刻を書き出す。

この時、プロセスP1の送信前〜送信後の時間Bは以下の通りになる。

    送信前〜送信後 = (トークン送信にかかる時間 + トークン受信にかかる時間) * 2

この2つの時間A, Bの差分は `プロセス待機にかかる時間 + プロセス復帰にかかる時間` となる。
この時、 `プロセス待機にかかる時間` と `プロセス復帰にかかる時間` を同一視すれば、
コンテキストスイッチにかかる時間は `(プロセス待機にかかる時間 + プロセス復帰にかかる時間) / 2` となる。

なお、
こういった時間の計測はOSの状況によっては正確に測ることが難しいので、
2つの時間A, Bを何度も測定してそれぞれの最小値を求め、
最小値の差分からコンテキストスイッチにかかる時間を算出することが望ましい。
(残念ながらこの方法でもそれほど正確には測れない)
